services:
  # API Service
  westmarch-api:
    build:
      context: .
      dockerfile: Westmarch-tool.API/Dockerfile
    container_name: westmarch-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=westmarch-sqlserver,1433;Database=WestmarchDB;User Id=sa;Password=${SQL_PASSWORD};TrustServerCertificate=True;
      - JwtSettings__SecretKey=${JWT_SECRET}
      - JwtSettings__Issuer=WestmarchAPI
      - JwtSettings__Audience=WestmarchWeb
      - JwtSettings__ExpirationMinutes=1440
    networks:
      - westmarch-network
    ports:
      - "5245:8080"
    restart: unless-stopped
    depends_on:
      - westmarch-sqlserver

  # Web Service
  westmarch-web:
    build:
      context: .
      dockerfile: Westmarch-tool.Web/Dockerfile
    container_name: westmarch-web
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - westmarch-network
    ports:
      - "5057:8080"
    restart: unless-stopped
    depends_on:
      - westmarch-api

  # Foundry VTT Service
  foundry-vtt:
    image: felddy/foundryvtt:release
    container_name: foundry-vtt
    hostname: foundry-sagemyrloc
    init: true
    restart: unless-stopped
    volumes:
      - foundry-data:/data
    environment:
      - FOUNDRY_USERNAME=${FOUNDRY_USERNAME}
      - FOUNDRY_PASSWORD=${FOUNDRY_PASSWORD}
      - FOUNDRY_ADMIN_KEY=${FOUNDRY_ADMIN_KEY}
      - FOUNDRY_LICENSE_KEY=${FOUNDRY_LICENSE_KEY}
      - FOUNDRY_MINIFY_STATIC_FILES=true
      - FOUNDRY_HOSTNAME=foundry.sagemyrloc.co.uk
      - FOUNDRY_ROUTE_PREFIX=
      - FOUNDRY_PROXY_PORT=443
      - FOUNDRY_PROXY_SSL=true
    networks:
      - westmarch-network
    ports:
      - "30000:30000"

  # SQL Server
  westmarch-sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: westmarch-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SQL_PASSWORD}
      - MSSQL_PID=Express
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - westmarch-network
    restart: unless-stopped

  # Adminer
  adminer:
    image: adminer
    container_name: westmarch-adminer
    ports:
      - "8080:8080"
    networks:
      - westmarch-network
    restart: unless-stopped

  # Nginx Proxy Manager
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    ports:
      - "80:80"
      - "443:443"
      - "81:81"
    environment:
      DB_SQLITE_FILE: "/data/database.sqlite"
    volumes:
      - npm-data:/data
      - npm-letsencrypt:/etc/letsencrypt
    networks:
      - westmarch-network
    restart: unless-stopped

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=n8n.sagemyrloc.co.uk
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.sagemyrloc.co.uk/
      - GENERIC_TIMEZONE=Europe/Amsterdam
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n-local-files:/files
    networks:
      - westmarch-network

networks:
  westmarch-network:
    driver: bridge

volumes:
  npm-data:
  npm-letsencrypt:
  foundry-data:
  sqlserver-data:
  n8n_data: